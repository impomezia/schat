var SendFileUtils={button:function(a,b){return'<a class="btn btn-small btn-file-'+a+'" data-tr="file-'+a+'" href="chat-sendfile:'+a+"/"+b+'">'+Utils.tr("file-"+a)+"</a>"},setStateTr:function(a,b){var c=$("#"+a+" .file-state");c.html(Utils.tr(b)),c.attr("data-tr",b),c.removeClass("file-state-inactive")},setStateText:function(a,b){var c=$("#"+a+" .file-state");c.html(b),c.removeAttr("data-tr"),c.removeClass("file-state-inactive")},progress:function(a,b,c){SendFileUtils.setStateText(a,b),$("#"+a+" .file-progress .bar").css("width",c+"%")},setFileIcon:function(a){var b=$("#"+a).data("imageId");try{SendFile.fileIcon(a).assignToHTMLImageElement(document.getElementById(b)),$("#"+b).show()}catch(c){$("#"+b).hide()}},updateState:function(a){if(null!==document.getElementById(a)){var b=SendFile.role(a),c=SendFile.state(a),d=$("#"+a+" .file-buttons");if("U"!=c&&($("#"+a+" .file-name").removeClass("file-only-name"),$("#"+a+" .btn-small").remove(),$("#"+a+" .file-progress").hide()),"W"==c)b?(SendFileUtils.setStateText(a,SimpleChat.bytesToHuman(SendFile.size(a))),d.append(SendFileUtils.button("saveas",a))):SendFileUtils.setStateTr(a,"file-waiting");else if("c"==c)SendFileUtils.setStateTr(a,"file-cancelled");else if("C"==c)SendFileUtils.setStateTr(a,"file-connecting"),$("#"+a+" .file-name").text(SendFile.fileName(a));else if("T"==c){$("#"+a+" .file-progress").show();var e=SendFile.progressInfo(a);e.hasOwnProperty("text")&&SendFileUtils.progress(a,e.text,e.percent)}else if("F"==c)if(b){var f=SendFile.fileUrls(a);SendFileUtils.setStateText(a,'<span data-tr="file-received">'+Utils.tr("file-received")+'</span> <a href="'+f.dir+'" data-tr="file-show">'+Utils.tr("file-show")+"</a>"),d.append(SendFileUtils.button("open",a)),$("#"+a+" .btn-file-open").attr("href",f.file)}else SendFileUtils.setStateTr(a,"file-sent");("W"==c||"C"==c||"T"==c)&&d.append(SendFileUtils.button("cancel",a)),alignChat()}}};Messages.addFileMessage=function(a){if(null===document.getElementById(a.Id)){var b=SimpleChat.randomId(),c=document.createElement("div");c.id=a.Id,c.setAttribute("class","container "+a.Type+"-type"),c.setAttribute("data-time",a.Date);var d='<div class="blocks '+a.Direction+'">';d+='<div class="file-sender">'+DateTime.template(a.Date,a.Day)+Messages.nameBlock(a.Author)+"</div>",d+='<div class="file-icon"><img id="'+b+'" src="" width="16" height="16" alt="" /></div>',d+='<div class="file-block"><span class="file-name file-only-name">'+a.File+'</span><br><span class="file-state file-state-inactive">&nbsp;</span></div>',d+='<div class="file-buttons btn-group"></div>',d+='<div class="file-progress"><div class="bar"></div></div><div style="clear:both;"></div>',d+="</div>",c.innerHTML=d,Messages.addHintedRawMessage(c,a.Hint),a.WeakId===!1&&ChatView.setLastMessage(a.Date),$("#"+a.Id).data("imageId",b),SendFileUtils.setFileIcon(a.Id)}},Messages.upgradeFileMessage=function(a){null!==document.getElementById(a.InternalId)&&(null===document.getElementById(a.Id)&&($("#"+a.InternalId).attr("id",a.Id),$("#"+a.Id+" .btn-file-cancel").attr("href","chat-sendfile:cancel/"+a.Id)),DateTime.update(a),ChatView.setLastMessage(a.Date))},"undefined"==typeof SendFile?SendFile={state:function(){return"U"},role:function(){return 1},size:function(){return 0},fileName:function(){return""},progressInfo:function(){return{}},fileUrls:function(){return{}}}:(SendFile.progress.connect(SendFileUtils.progress),SendFile.stateChanged.connect(SendFileUtils.updateState)),Messages.onAdd.push(SendFileUtils.updateState);