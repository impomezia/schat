var ACL_DEFAULT=-1,ACL_OWNER=15,ACL_MODERATOR=22,ACL_READWRITE=6,ACL_READONLY=4,ACL_FORBIDDEN=0,ACL_CHANNEL_READWRITE=502,ACL_CHANNEL_READONLY=484,ACL_CHANNEL_FORBIDDEN=448,Channels={acl:-1,timeout:{visibility:null,acl:null,logging:null},reload:function(){1==Pages.current&&(SimpleChat.isOnline()&&Loader.spinner.add("loading/info"),Channels.info(SimpleChat.feed(Settings.getId(),FEED_NAME_INFO,4),300))},info:function(a,b){a.hasOwnProperty("title")&&$("#channel-title-text").text(a.title.text),300!=b&&Loader.spinner.remove("loading/info"),Channels.stopSpinner("visibility",b),Channels.stopSpinner("logging",b),Channels.stopSpinner("acl",b)},stopSpinner:function(a,b){if(null!==Channels.timeout[a]&&(clearInterval(Channels.timeout[a]),$("#"+a+"-spinner").addClass("hide"),200!=b&&303!=b)){var c=$("#"+a+"-error");c.removeClass("hide"),c.text(SimpleChat.statusText(b))}},startSpinner:function(a){$("#"+a+"-error").addClass("hide"),Channels.timeout[a]=setTimeout(function(){$("#"+a+"-spinner").removeClass("hide")},400)},feed:function(a){a!==!1&&(a.feed==FEED_NAME_INFO&&a.id==Settings.getId()?Channels.info(a.data,a.status):a.feed==FEED_NAME_ACL&&("reply"==a.type&&Channels.stopSpinner("acl",a.status),Channels.online()))},online:function(){Channels.acl=SimpleChat.match(Settings.getId(),SimpleChat.id());var a=$("#settings-dropdown");-1!=Channels.acl&&9&Channels.acl?a.length||$("#channel-buttons").append('<div id="settings-dropdown" class="dropdown pull-right"><a id="channel-settings" data-toggle="dropdown" href="#"></a>'+Channels.menu()+"</div>"):a.remove()},menu:function(){return'<ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu"><li><a href="#" data-tr="channels_title" class="modal-toggle" data-handler="title">'+Utils.tr("channels_title")+'</a></li><li><a href="#" data-tr="channels_options" class="modal-toggle" data-handler="options">'+Utils.tr("channels_options")+"</a></li></ul>"},editAcl:function(a){if(null===Modal.current){$("#modal-header h3").html(Messages.nameTemplate(SimpleChat.channel(a)));var b=$("#modal-body");b.append("<form>"),b.append('<form><div id="acl-row" class="row"><label for="acl" data-tr="channels_permissions">'+Utils.tr("channels_permissions")+'</label> <select id="acl" data-user="'+a+'" class="btn"><option value="-1" data-tr="channels_default">'+Utils.tr("channels_default")+'</option><option value="15" data-tr="channels_owner">'+Utils.tr("channels_owner")+'</option><option value="22" data-tr="channels_moderator">'+Utils.tr("channels_moderator")+'</option><option value="6" data-tr="channels_readwrite">'+Utils.tr("channels_readwrite")+'</option><option value="4" data-tr="channels_readonly">'+Utils.tr("channels_readonly")+'</option><option value="0" data-tr="channels_forbidden">'+Utils.tr("channels_forbidden")+'</option></select> <i id="acl-spinner" class="icon-spinner hide"></i><div id="acl-error" class="alert alert-error hide"></div></div></form>'),$("#acl").val(Channels.value(a)),Modal.current="acl",$("#modal").modal()}},value:function(a){var b=SimpleChat.match(Settings.getId(),a);if(9&b)return ACL_OWNER;var c=SimpleChat.feed(Settings.getId(),FEED_NAME_ACL,3);return c!==!1&&c.hasOwnProperty(a)?16&b?ACL_MODERATOR:b==ACL_READWRITE||b==ACL_READONLY||b==ACL_FORBIDDEN?b:-1:-1},setTitle:function(a){a.preventDefault();var b=$("#title-edit").val();$("#modal").modal("hide"),$("#channel-title-text").text()!=b&&SimpleChat.request(Settings.getId(),FEED_METHOD_POST,INFO_FEED_TITLE_REQ,{value:b,options:7})},setAcl:function(){var a=$(this).find("option:selected").attr("value"),b=$(this).attr("data-user"),c=Settings.getId();a==ACL_OWNER?SimpleChat.request(c,FEED_METHOD_POST,ACL_FEED_HEAD_OWNER_REQ,{value:b,options:6}):a==ACL_DEFAULT?SimpleChat.request(c,FEED_METHOD_DELETE,ACL_FEED_HEAD_OTHER_REQ+"/"+b,{options:6}):SimpleChat.request(c,FEED_METHOD_POST,ACL_FEED_HEAD_OTHER_REQ+"/"+b,{value:a,options:6}),Channels.startSpinner("acl")}};Modal.create.title=function(a){ChatView.allowFocus(!0);var b=$("#modal-header h3");b.text(a.target.innerText),b.attr("data-tr","channels_title"),$("#modal-body").append('<form id="title-form"><div id="title-group" class="control-group"><input id="title-edit" type="text" maxlength="200"><button id="title-ok" type="submit" class="btn" data-tr="ok">'+Utils.tr("ok")+"</button></div></form>"),$("#title-edit").val($("#channel-title-text").text())},Modal.shown.title=function(){$("#title-edit").focus()},Modal.hidden.title=function(){ChatView.allowFocus(!1)};var OptionsWindow={load:function(a){var b=$("#modal-header h3");b.text(a.target.innerText),b.attr("data-tr","channels_options"),SimpleChat.feed(Settings.getId(),FEED_NAME_INFO,1),$.ajax({url:"channel_options.html",isLocal:!0,dataType:"html",success:function(a){$("#modal-body").html(a),$("#channel-options [data-tr]").each(function(){Utils.TR($(this).attr("data-tr"))});var b=OptionsWindow;b.retranslate(),b.reload(),$("#visibility").on("change",b.setVisibility),$("#permissions").on("change",b.setPermissions),$("#logging").on("change",b.setLogging),$("#pin-button").on("click",b.pin),$("#sudo-button").on("click",b.sudo)}})},reload:function(){var a=SimpleChat.feed(Settings.getId(),FEED_NAME_INFO,3);if(a!==!1)var b=a.visibility||0,c=a.sudo||!1;$("#visibility").val(b),$("#visibility-row").toggleClass("pinnable",OptionsWindow.isPinnable(b));var d=SimpleChat.match(Settings.getId(),""),e=ACL_CHANNEL_READWRITE;4==d?e=ACL_CHANNEL_READONLY:0==d&&(e=ACL_CHANNEL_FORBIDDEN),$("#permissions").val(e),$("#permissions-row").toggleClass("strict-access",e!=ACL_CHANNEL_READWRITE),$("#pin-button").toggleClass("active",1==a[INFO_FEED_PINNED_KEY]),$("#sudo-button").toggleClass("active",c!==!1),$("#logging").attr("checked",a[INFO_FEED_LOGGING_KEY]!==!1)},setVisibility:function(){var a=$(this).val();$("#visibility-row").toggleClass("pinnable",OptionsWindow.isPinnable(a)),SimpleChat.request(Settings.getId(),FEED_METHOD_POST,INFO_FEED_VISIBILITY_REQ,{value:a,options:7}),Channels.startSpinner("visibility")},setPermissions:function(){var a=$(this).val();SimpleChat.request(Settings.getId(),FEED_METHOD_PUT,ACL_FEED_HEAD_MASK_REQ,{value:a,options:6}),$("#permissions-row").toggleClass("strict-access",a!=ACL_CHANNEL_READWRITE),Channels.startSpinner("acl")},setLogging:function(){SimpleChat.request(Settings.getId(),FEED_METHOD_POST,INFO_FEED_LOGGING_REQ,{value:$(this).is(":checked"),options:7}),Channels.startSpinner("logging")},pin:function(){$(this).toggleClass("active"),SimpleChat.request(Settings.getId(),FEED_METHOD_POST,INFO_FEED_PINNED_REQ,{value:$(this).hasClass("active"),options:7}),Channels.startSpinner("visibility")},sudo:function(){$(this).toggleClass("active"),SimpleChat.request(Settings.getId(),FEED_METHOD_POST,INFO_FEED_SUDO_REQ,{value:$(this).hasClass("active"),options:7}),Channels.startSpinner("acl")},isPinnable:function(a){return(a>=0&&9&SimpleChat.match(SimpleChat.serverId(),SimpleChat.id()))>0},retranslate:function(){$("#channel-options").length&&(Utils.adjustWidth($(".options-label")),Utils.adjustWidth($(".options-select")),$("#visibility").addClass("btn"),$("#pin-button").attr("title",Utils.tr("channels_pin")),$("#sudo-button").attr("title",Utils.tr("channels_sudo_invite")))}};Modal.create.options=OptionsWindow.load,Modal.hidden.options=function(){clearTimeout(Channels.timeout.visibility),clearTimeout(Channels.timeout.acl)},$(document).ready(function(){$("#page-header").append('<div id="channel-title"><div id="channel-title-text"></div></div>');var a=$("#modal-body");a.on("click.title","#title-ok",Channels.setTitle),a.on("change.acl","#acl",Channels.setAcl),Channels.online()}),Pages.onInfo.push(Channels.reload),"undefined"!=typeof ChatView&&(ChatView.reload.connect(Channels.reload),ChatView.feed.connect(Channels.feed)),"undefined"!=typeof SimpleChat&&(SimpleChat.online.connect(Channels.online),SimpleChat.retranslated.connect(OptionsWindow.retranslate));